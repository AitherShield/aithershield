version: "3.9"

services:
    ollama:
        image: ollama/ollama:latest
        container_name: aithershield-ollama
        restart: unless-stopped
        ports:
            - "11434:11434" # Ollama API
        volumes:
            - ollama_data:/root/.ollama
        deploy: # GPU access (Compose v2+ syntax)
            resources:
                reservations:
                    devices:
                        - driver: nvidia
                          count: all # or device_ids: ['0'] if multi-GPU and want specific
                          capabilities: [gpu]
        environment:
            - OLLAMA_HOST=0.0.0.0
            - OLLAMA_ORIGINS=*
            # Optional: limit models or debug
            # - OLLAMA_DEBUG=1
        # Pull a starter model on first start (or do manually: docker exec -it aithershield-ollama ollama pull qwen2.5:14b)
        command: serve
        # healthcheck:
        #   test: ["CMD", "curl", "-f", "http://localhost:11434/api/tags"]
        #   interval: 30s
        #   timeout: 10s
        #   retries: 3

    elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.15.3 # or latest 8.x
        container_name: aithershield-es
        restart: unless-stopped
        ports:
            - "9200:9200" # ES HTTP API
            - "9300:9300" # node-to-node (optional for dev)
        environment:
            - discovery.type=single-node
            - xpack.security.enabled=false # dev only! enable in prod
            - ES_JAVA_OPTS=-Xms2g -Xmx2g # adjust based on host RAM
            - "logger.org.elasticsearch=INFO"
        volumes:
            - es_data:/usr/share/elasticsearch/data
        ulimits:
            memlock: -1
            nofile: 65536
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "curl -s -f http://localhost:9200/_cat/health?h=status",
                ]
            interval: 30s
            timeout: 10s
            retries: 5

    chroma:
        image: ghcr.io/chroma-core/chroma:latest
        container_name: aithershield-chroma
        restart: unless-stopped
        ports:
            - "8000:8000" # Chroma HTTP API
        volumes:
            - chroma_data:/index_data
        environment:
            - IS_PERSISTENT=TRUE
            - ANONYMIZED_TELEMETRY=FALSE
            # For production-like: use ClickHouse backend (more scalable)
            # - CHROMA_DB_IMPL=clickhouse
            # - CLICKHOUSE_HOST=clickhouse  (add clickhouse service if needed)
        # healthcheck:
        #   test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/heartbeat"]
        #   interval: 30s

    # Placeholder: your Rust backend / ingestion / API service
    # Build from your source once you have a Dockerfile
    backend:
        build:
            context: .
            dockerfile: Dockerfile # create this next â€” see below
        container_name: aithershield-backend
        restart: unless-stopped
        ports:
            - "8001:8000" # your Rust API (adjust port)
        volumes:
            - .:/app # dev hot-reload if using cargo watch / rust-analyzer
            - ./logs:/app/logs # example log output dir
        environment:
            - RUST_LOG=info
            - OLLAMA_URL=http://ollama:11434
            - ELASTICSEARCH_URL=http://elasticsearch:9200
            - CHROMA_URL=http://chroma:8000
            # Add your hybrid flags, Grok API key (optional), etc.
            # - GROK_API_KEY=your-key-here
        depends_on:
            ollama:
                condition: service_started
            elasticsearch:
                condition: service_healthy
            chroma:
                condition: service_started
        # For dev: run with cargo watch or your entrypoint
        # command: cargo run --bin aithershield-server

volumes:
    ollama_data:
    es_data:
    chroma_data:

networks:
    default:
        name: aithershield-net
